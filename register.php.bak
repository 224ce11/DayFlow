<?php
session_start();
include 'db_connect.php';

$message = "";
$messageType = "";

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    
    $company_name = filter_input(INPUT_POST, 'company_name', FILTER_SANITIZE_STRING);
    $full_name = filter_input(INPUT_POST, 'full_name', FILTER_SANITIZE_STRING);
    $email = filter_input(INPUT_POST, 'email', FILTER_SANITIZE_EMAIL);
    $phone = filter_input(INPUT_POST, 'phone', FILTER_SANITIZE_STRING);
    $password = $_POST['password'];
    $confirm_password = $_POST['confirm_password'];

    if ($password !== $confirm_password) {
        $message = "Passwords do not match.";
        $messageType = "error";
    } else {
        $hashed_password = password_hash($password, PASSWORD_DEFAULT);
        $company_id = null;
        $is_valid = true;

        // --- New Company Registration Logic (HR/Admin Only) ---
        // Check if company name exists
        $check_c = $conn->prepare("SELECT id FROM companies WHERE company_name = ?");
        $check_c->bind_param("s", $company_name);
        $check_c->execute();
        if ($check_c->get_result()->num_rows > 0) {
            $message = "Company Name already registered.";
            $messageType = "error";
            $is_valid = false;
        } else {
            // Generate Random Company Code
            $company_code = 'CMP-' . strtoupper(substr(md5(time()), 0, 4));
            
            // Create Company
            $ins_c = $conn->prepare("INSERT INTO companies (company_name, company_code) VALUES (?, ?)");
            $ins_c->bind_param("ss", $company_name, $company_code);
            if ($ins_c->execute()) {
                $company_id = $conn->insert_id;
                $role = 'admin'; 
            } else {
                $message = "Error creating company.";
                $messageType = "error";
                $is_valid = false;
            }
            $ins_c->close();
        }
        $check_c->close();

        if ($is_valid && $company_id) {
            // --- Generate Login ID ---
            // 1. Company Prefix
            $co_parts = explode(' ', trim($company_name));
            if (count($co_parts) >= 2) {
                $co_prefix = strtoupper(substr($co_parts[0], 0, 1) . substr($co_parts[1], 0, 1));
            } else {
                $co_prefix = strtoupper(substr($company_name, 0, 2));
            }
            if (strlen($co_prefix) < 2) $co_prefix = "XY"; 

            // 2. Name Code
            $name_parts = explode(' ', trim($full_name));
            $fname = $name_parts[0];
            $lname = (count($name_parts) > 1) ? end($name_parts) : $fname;
            $name_code = strtoupper(substr($fname, 0, 2) . substr($lname, 0, 2));
            if (strlen($name_code) < 4) $name_code = str_pad($name_code, 4, "X"); 

            // 3. Year & Serial
            $year = date("Y");
            $count_sql = "SELECT count(*) as count FROM users WHERE year(created_at) = ?";
            $count_stmt = $conn->prepare($count_sql);
            $count_stmt->bind_param("s", $year);
            $count_stmt->execute();
            $row = $count_stmt->get_result()->fetch_assoc();
            $serial = str_pad($row['count'] + 1, 4, '0', STR_PAD_LEFT);
            $count_stmt->close();

            $login_id = $co_prefix . $name_code . $year . $serial;

            // Insert User (Admin)
            $stmt = $conn->prepare("INSERT INTO users (company_id, login_id, full_name, email, phone, password, role) VALUES (?, ?, ?, ?, ?, ?, ?)");
            $stmt->bind_param("issssss", $company_id, $login_id, $full_name, $email, $phone, $hashed_password, $role);

            if ($stmt->execute()) {
                $message = "<strong>Organization Registered!</strong><br>Your Admin Login ID is: <strong style='font-size:1.2em'>$login_id</strong><br>Use this ID to login and add your employees.";
                $messageType = "success";
            } else {
                $message = "Error registering user: " . $stmt->error;
                $messageType = "error";
            }
            $stmt->close();
        }
    }
}
$conn->close();
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Organization - Dayflow</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="login_styles.css">
</head>
<body>

    <div class="login-wrapper">
        <div class="bg-shape shape-1"></div>
        <div class="bg-shape shape-2"></div>
        <div class="bg-shape shape-3"></div>

        <div class="login-container">
            <div class="login-header">
                <a href="homepage.php" class="logo-center"><i class="fa fa-layer-group"></i> Dayflow</a>
                <h2>Setup Organization</h2>
                <p>Register your company to start managing your team.</p>
            </div>

            <?php if (!empty($message)): ?>
                <div class="error-message" style="<?php echo ($messageType == 'success') ? 'background:#ecfdf5; color:#047857; border-color:#6ee7b7;' : ''; ?>">
                   <?php if($messageType == 'success') { echo '<i class="fa fa-check-circle"></i>'; } else { echo '<i class="fa fa-exclamation-circle"></i>'; } ?>
                   <span><?php echo $message; ?></span>
                </div>
            <?php endif; ?>

            <form action="register.php" method="POST" class="login-form">
                
                <div class="form-group">
                    <label for="company_name">Company Name</label>
                    <div class="input-with-icon">
                        <i class="fa fa-building"></i>
                        <input type="text" id="company_name" name="company_name" placeholder="Acme Corp" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="full_name">Admin Full Name</label>
                    <div class="input-with-icon">
                        <i class="fa fa-user"></i>
                        <input type="text" id="full_name" name="full_name" placeholder="John Doe" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Admin Email</label>
                    <div class="input-with-icon">
                        <i class="fa fa-envelope"></i>
                        <input type="email" id="email" name="email" placeholder="admin@dayflow.com" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <div class="input-with-icon">
                        <i class="fa fa-phone"></i>
                        <input type="tel" id="phone" name="phone" placeholder="+1..." required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-with-icon">
                        <i class="fa fa-lock"></i>
                        <input type="password" id="password" name="password" placeholder="••••••••" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm Password</label>
                    <div class="input-with-icon">
                        <i class="fa fa-lock"></i>
                        <input type="password" id="confirm_password" name="confirm_password" placeholder="••••••••" required>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">
                    Create Workspace <i class="fa fa-arrow-right"></i>
                </button>
            </form>

            <div class="login-footer">
                <p>Already have an account? <a href="Login.php">Sign In</a></p>
            </div>
        </div>
    </div>
    <script src="style.js"></script>
</body>
</html>
